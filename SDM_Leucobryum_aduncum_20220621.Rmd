---
title: "SDMs of Leucobryum"
author: "Puwadol Chawengkul"
date: "6/21/2022"
output: pdf_document
editor_options: 
  chunk_output_type: console
---

# 0. Load the libraries

```{r Libraries}
library(maptools)
library(raster) #read shape file
library(tidyverse)
library(rgdal)
library(maps) #map data
library(broom)
library(dismo) #species distribution
library(rJava)
library(randomForest)
library(plyr)

set.seed(1) #set random number for entire script
```

# 1. Main map

## 1.1 Get map data

```{r Get map data}
thai0 <- getData("GADM", country = "THA", level = 0)
thai1 <- getData("GADM", country = "THA", level = 1)
```

## 1.2 ggplot2 map

```{r ggplot2 map}
ggplot() +
  geom_polygon(aes(long, lat, group = group), data = thai0, 
               fill = "#99d8c9", color = "#2ca25f") +
  coord_equal() +
  theme_minimal() +
  theme(panel.background = element_rect(fill = "#E9FFFF")) +
  labs(x = "Longtitude (°E)", y = "Latitude (°N)") 
```

# 2. Species occurrence

## 2.1 Import from GBIF

```{r Import from GBIF}
gbif <- gbif("leucobryum","aduncum")
```

Clean data

```{r Clean GBIF data}
gbif.clean <- gbif %>% 
  #remove Leucobryum aduncum var. scalare
  filter(acceptedScientificName == "Leucobryum aduncum Dozy & Molkenboer, 1854") %>% 
  filter(fullCountry == "Thailand") %>% 
  select(lon, lat) %>% 
  na.omit()
```

## 2.2 Import from .csv

```{r Import from .csv}
csv <- read_csv("Leucobryum-Specimens.csv")
```

Clean data

```{r Clean .csv data}
csv.clean <- csv %>% 
  filter(Corrected_name == "Leucobryum aduncum") %>% 
  select(lon, lat) %>% 
  na.omit()
```

## 2.3 Merge GBIF and .csv

```{r Merge GBIF and .csv}
gbif.csv <- rbind(gbif.clean,csv.clean)
```

## 2.4 Species occurrence plot

```{r Species occurrence plot}
ggplot() +
  geom_polygon(aes(long, lat, group = group), data = thai1, fill = "white", color = "black") +
  geom_point(aes(lon, lat), data = gbif.csv, color = "red", size = 3) +
  coord_equal() +
  theme_minimal() +
  theme(panel.background = element_rect(fill = "#E9FFFF")) +
  labs(x = "Longtitude (°E)", y = "Latitude (°N)") 
```

# 3. Species Distribution Modeling

## 3.1 Get bioclim and elevation data

Get the available bioclim data from the worldclim dataset. See more at [Bioclimatic variables](https://www.worldclim.org/data/bioclim.html)

```{r Get bioclim data}
bioclim <- getData('worldclim', var = 'bio', res = 2.5)
cmip5.45 <- getData('CMIP5', var = 'bio', res = 2.5, rcp = 45, model = 'AC', year = 70)
cmip5.85 <- getData('CMIP5', var = 'bio', res = 2.5, rcp = 85, model = 'AC', year = 70)
```

Get elevation from SRTM 90 m resolution data between -60 and 60 latitude

```{r Get elevation data}
elevation <- getData('alt', country = "THA", mask = FALSE)
```

Crop climate data to Thailand

```{r Crop bioclim data}
bioclim.thai.crop <- crop(bioclim, thai0)
bioclim.thai <- mask(bioclim.thai.crop, thai0)
plot(bioclim.thai[[1]]) #or plot(bioclim.thai$bio1)

cmip5.45.thai.crop <- crop(cmip5.45, thai0)
cmip5.45.thai <- mask(cmip5.45.thai.crop, thai0)
plot(cmip5.45.thai[[1]]) #or plot(cmip5.45.thai$bio1)

cmip5.85.thai.crop <- crop(cmip5.85, thai0)
cmip5.85.thai <- mask(cmip5.85.thai.crop, thai0)
plot(cmip5.85.thai[[1]]) #or plot(cmip5.85.thai$bio1)
```

Crop elevation data to Thailand

```{r Crop elevation data}
elevation.thai.crop <- crop(elevation, thai0)
elevation.thai.0 <- mask(elevation.thai.crop, thai0)
plot(elevation.thai.0)
```

Elevation variable plot

```{r Elevation variable plot}
elevation.thai.0.df <- as.data.frame(elevation.thai.0, xy = TRUE)

#Calculate midpoint value of probability for color setting
midpoint.alt <- (max(elevation.thai.0.df$THA_alt, na.rm = TRUE)
             -min(elevation.thai.0.df$THA_alt, na.rm = TRUE))/2

ggplot() +
  geom_raster(data = elevation.thai.0.df, aes(x,y, fill = THA_alt)) +
  geom_polygon(aes(long, lat, group = group), data = thai1, fill = NA, color = "gray80", size = 0.1) +
  scale_fill_gradient2("Elevation (m)", 
                      high = "red", mid = "orange", midpoint = midpoint.alt, 
                      low = "white", na.value = NA) +
  theme(panel.background = element_rect(fill = "black")) +
  coord_equal() +
  labs(x = "Longtitude (°E)", y = "Latitude (°N)")
```

Make "elevation.thai" be equal column to "bioclim.thai" (for stacking)

```{r Stack preparation}
elevation.thai <- resample(elevation.thai.0, bioclim.thai, method = "bilinear")
plot(elevation.thai[[1]])
```

## 3.2 Build the models

Select only lon and lat of species occurrence

```{r Select lon and lat}
gbif.csv.xy <- select(gbif.csv, lon, lat)
gbif.csv.xy
```

Split into training and testing dataset

```{r Split training and testing}
numrow <- nrow(gbif.csv.xy)
sample <- sample(numrow, 0.3 * numrow)
gbif.csv.xy.train <- gbif.csv.xy[-sample, ]
gbif.csv.xy.test <- gbif.csv.xy[sample, ]
```

Create predictors

```{r Create predictors}
predictors <- stack(bioclim.thai[[c(1:19)]], elevation.thai) #choose bio1-19 and THA_alt
```

Create random background points

```{r Create random background points}
bg <- randomPoints(predictors, 1000)
numrow.bg <- nrow(bg)
sample.bg <- sample(numrow.bg, 0.3 * numrow.bg)
bg.train <- bg[-sample.bg, ]
bg.test <- bg[sample.bg, ]
```

### 3.2.1 Build Bioclim model

```{r Build Bioclim model}
bc.model <- bioclim(x = predictors, p = gbif.csv.xy.train)
bc.model
```

### 3.2.2 Build MaxEnt model

```{r Build MaxEnt model}
me.model <- maxent(x = predictors, p = gbif.csv.xy.train)
me.model
```

### 3.2.3 Build GLM model

Create present and absent environmental dataset

```{r Create present and absent environmental dataset}
colnames(bg.train) <- c("lon","lat")
train <- rbind(gbif.csv.xy.train, bg.train)
pb.train <- c(rep(1, nrow(gbif.csv.xy.train)), rep(0, nrow(bg.train)))
envtrain.0 <- raster::extract(predictors, train)
envtrain <- data.frame(cbind(pa=pb.train, envtrain.0))
```

```{r Build GLM model}
glm.model <- glm(pa ~ ., family = gaussian(link = "identity"), data=envtrain)
glm.model
#predict(glm.model)
```

### 3.2.4 Build Random Forest model

This model also need present and absent environmental dataset

```{r Build Random Forest model}
rf.model <- randomForest(pa ~ ., data = envtrain, na.action = na.omit)
rf.model
```

## 3.3 See the response curves

### 3.3.1 Bioclim model response curves

```{r Bioclim model response curves}
#response(bc.model) #Figure margins too large
#response(bc.model, var = "bio1") #For example
response(bc.model, var = c(1:5))
response(bc.model, var = c(6:10))
response(bc.model, var = c(11:15))
response(bc.model, var = c(16:20))
```

### 3.3.2 MaxEnt model response curves

```{r Variable contribution}
plot(me.model)
```

```{r MaxEnt model response curves}
response(me.model, var = c(1:5))
response(me.model, var = c(6:10))
response(me.model, var = c(11:15))
response(me.model, var = c(16:20))
```

## 3.4 Plot the predicted data onto the map

Distribution model predictions

```{r Distribution model predictions}
predict.presence.bc <- dismo::predict(object = bc.model, x = predictors)
predict.presence.me <- dismo::predict(object = me.model, x = predictors)
ext <- extent(90, 110, 5, 22)
predict.presence.glm <- predict(predictors, glm.model, ext=ext)
predict.presence.rf <- predict(predictors, rf.model, ext=ext)
```

Basic plot

```{r Basic plot}
#For example only
plot(predict.presence.bc)
points(lat ~ lon, data = gbif.csv.xy, col = "red") #Have problem if zoom
```

Plot in ggplot2

### 3.4.1 Turn raster into df

```{r Turn raster into df}
predict.presence.bc.df <- as.data.frame(predict.presence.bc, xy = TRUE) %>% 
  mutate(layer2 = ifelse(layer=="NaN",NA,layer)) #Clean layer for transparent background
predict.presence.me.df <- as.data.frame(predict.presence.me, xy = TRUE) %>% 
  mutate(layer2 = ifelse(layer=="NaN",NA,layer)) #Clean layer for transparent background
predict.presence.glm.df <- as.data.frame(predict.presence.glm, xy = TRUE) %>% 
  mutate(layer2 = ifelse(layer=="NaN",NA,layer)) #Clean layer for transparent background
predict.presence.rf.df <- as.data.frame(predict.presence.rf, xy = TRUE) %>% 
  mutate(layer2 = ifelse(layer=="NaN",NA,layer)) #Clean layer for transparent background
```

### 3.4.2 Bioclim model plot

```{r Bioclim model plot}
#Calculate midpoint value of probability for color setting
midpoint.bc <- (max(predict.presence.bc.df$layer2, na.rm = TRUE)
             -min(predict.presence.bc.df$layer2, na.rm = TRUE))/2

ggplot() +
  geom_raster(data = predict.presence.bc.df, aes(x,y, fill = layer2)) +
  geom_polygon(aes(long, lat, group = group), data = thai1, fill = NA, color = "gray80", size = 0.1) +
  geom_point(data = gbif.csv.xy, aes(lon, lat), color = "dark green", shape = 1) +
  scale_fill_gradient2("probability", 
                      high = "red", mid = "orange", midpoint = midpoint.bc, 
                      low = "white", na.value = NA) +
  theme(panel.background = element_rect(fill = "black")) +
  coord_equal() +
  labs(x = "Longtitude (°E)", y = "Latitude (°N)")
```

### 3.4.3 MaxEnt model plot

```{r MaxEnt model plot}
#Calculate midpoint value of probability for color setting
midpoint.me <- (max(predict.presence.me.df$layer2, na.rm = TRUE)
             -min(predict.presence.me.df$layer2, na.rm = TRUE))/2

ggplot() +
  geom_raster(data = predict.presence.me.df, aes(x,y, fill = layer2)) +
  geom_polygon(aes(long, lat, group = group), data = thai1, fill = NA, color = "gray80", size = 0.1) +
  geom_point(data = gbif.csv.xy, aes(lon, lat), color = "dark green", shape = 1) +
  scale_fill_gradient2("probability", 
                      high = "red", mid = "orange", midpoint = midpoint.me, 
                      low = "white", na.value = NA) +
  theme(panel.background = element_rect(fill = "black")) +
  coord_equal() +
  labs(x = "Longtitude (°E)", y = "Latitude (°N)")
```

### 3.4.4 GLM model plot

```{r GLM model plot}
#Calculate midpoint value of probability for color setting
midpoint.glm <- (max(predict.presence.glm.df$layer2, na.rm = TRUE)
             -min(predict.presence.glm.df$layer2, na.rm = TRUE))/2

ggplot() +
  geom_raster(data = predict.presence.glm.df, aes(x,y, fill = layer2)) +
  geom_polygon(aes(long, lat, group = group), data = thai1, fill = NA, color = "gray80", size = 0.1) +
  geom_point(data = gbif.csv.xy, aes(lon, lat), color = "dark green", shape = 1) +
  scale_fill_gradient2("probability", 
                      high = "red", mid = "orange", midpoint = midpoint.glm, 
                      low = "white", na.value = NA) +
  theme(panel.background = element_rect(fill = "black")) +
  coord_equal() +
  labs(x = "Longtitude (°E)", y = "Latitude (°N)")

#hist(predict.presence.glm.df$layer2)
```

### 3.4.5 Random Forest model plot

```{r Random Forest model plot}
#Calculate midpoint value of probability for color setting
midpoint.rf <- (max(predict.presence.rf.df$layer2, na.rm = TRUE)
             -min(predict.presence.rf.df$layer2, na.rm = TRUE))/2

ggplot() +
  geom_raster(data = predict.presence.rf.df, aes(x,y, fill = layer2)) +
  geom_polygon(aes(long, lat, group = group), data = thai1, fill = NA, color = "gray80", size = 0.1) +
  geom_point(data = gbif.csv.xy, aes(lon, lat), color = "dark green", shape = 1) +
  scale_fill_gradient2("probability", 
                      high = "red", mid = "orange", midpoint = midpoint.rf, 
                      low = "white", na.value = NA) +
  theme(panel.background = element_rect(fill = "black")) +
  coord_equal() +
  labs(x = "Longtitude (°E)", y = "Latitude (°N)")
```

## 3.5 Evaluate the model

AUC = Area Under Curve is the area under the curve of True Positive Rate (TPR) vs. False Positive Rate (FPR) If AUC is high, it means more likely to get the correct prediction (true positives)

Check Spatial Sorting Bias (SSB)

```{r Check Spatial Sorting Bias (SSB)}
ssb <- ssb(gbif.csv.xy.test, bg.test, gbif.csv.xy.train)
ssb[,1] / ssb[,2]
#If there is no SSB this value should be 1, close to 0 indicating that SSB is very strong.
```

Subsample to remove SSB

```{r Remove SSB}
i <- pwdSample(gbif.csv.xy.test, bg.test, gbif.csv.xy.train, n=1, tr=0.1)
gbif.csv.xy.test.pwd <- gbif.csv.xy.test[!is.na(i[,1]), ]
bg.test.pwd <- bg.test[na.omit(as.vector(i)), ]
sb2 <- ssb(gbif.csv.xy.test.pwd, bg.test.pwd, gbif.csv.xy.train)
sb2[1]/sb2[2]
```

### 3.5.1 Before remove SSB (don't use)

```{r Evaluate Bioclim model with SSB}
e.bc.0 <- evaluate(bc.model, p=gbif.csv.xy.test, a=bg.test, x= predictors)
e.bc.0
plot(e.bc.0, "ROC") #Visualize AUC with ROC curve
```

```{r Evaluate MaxEnt model with SSB}
e.me.0 <- evaluate(me.model, p=gbif.csv.xy.test, a=bg.test, x= predictors)
e.me.0
plot(e.me.0, "ROC") #Visualize AUC with ROC curve
```

```{r Evaluate GLM model with SSB}
e.glm.0 <- evaluate(glm.model, p=gbif.csv.xy.test, a=bg.test, x= predictors)
e.glm.0
plot(e.glm.0, "ROC") #Visualize AUC with ROC curve
```

```{r Evaluate Random Forest model with SSB}
e.rf.0 <- evaluate(glm.model, p=gbif.csv.xy.test, a=bg.test, x= predictors)
e.rf.0
plot(e.rf.0, "ROC") #Visualize AUC with ROC curve
```

### 3.5.2 After remove SSB

```{r Evaluate Bioclim model without SSB}
e.bc <- evaluate(bc.model, p=gbif.csv.xy.test.pwd, a=bg.test.pwd, x= predictors)
e.bc
plot(e.bc, "ROC") #Visualize AUC with ROC curve
```

```{r Evaluate MaxEnt model without SSB}
e.me <- evaluate(me.model, p=gbif.csv.xy.test.pwd, a=bg.test.pwd, x= predictors)
e.me
plot(e.me, "ROC") #Visualize AUC with ROC curve
```

```{r Evaluate GLM model without SSB}
e.glm <- evaluate(glm.model, p=gbif.csv.xy.test.pwd, a=bg.test.pwd, x= predictors)
e.glm
plot(e.glm, "ROC") #Visualize AUC with ROC curve
```

```{r Evaluate Random Forest model without SSB}
e.rf <- evaluate(rf.model, p=gbif.csv.xy.test.pwd, a=bg.test.pwd, x= predictors)
e.rf
plot(e.rf, "ROC") #Visualize AUC with ROC curve
```

## 3.6 Combined model predictions

```{r Make a raster stack}
models <- stack(predict.presence.bc, predict.presence.me, 
                predict.presence.glm, predict.presence.rf)
names(models) <- c("Bioclim", "Maxent", "GLM", "RF")
plot(models)
```

```{r Simple average}
mean.models <- mean(models)

#Basic plot
plot(mean.models, main = "Average score")
```

```{r Weighted mean of all models}
auc <- sapply(list(e.bc, e.me, e.glm, e.rf), function(x) x@auc)
weight <- (auc-0.5)^2
weight.model <- weighted.mean(models[[c("Bioclim", "Maxent", "GLM", "RF")]], weight)

#Basic plot
plot(weight.model, main = "Weighted mean of all models")

#Turn raster into df
predict.presence.w.df <- as.data.frame(weight.model, xy = TRUE) %>% 
  mutate(layer2 = ifelse(layer=="NaN",NA,layer)) #Clean layer for transparent background

#Calculate midpoint value of probability for color setting
midpoint.w <- (max(predict.presence.w.df$layer2, na.rm = TRUE)
             -min(predict.presence.w.df$layer2, na.rm = TRUE))/2

ggplot() +
  geom_raster(data = predict.presence.w.df, aes(x,y, fill = layer2)) +
  geom_polygon(aes(long, lat, group = group), data = thai1, fill = NA, color = "gray80", size = 0.1) +
  geom_point(data = gbif.csv.xy, aes(lon, lat), color = "red", shape = 1) +
  scale_fill_gradient2("probability", 
                      high = "dark green", mid = "green", midpoint = 0.3, 
                      low = "white", na.value = NA, breaks = c(0,0.25,0.5,0.75), limits = c(0,0.75)) +
  theme(panel.background = element_rect(fill = "black")) +
  coord_equal() +
  labs(x = "Longtitude (°E)", y = "Latitude (°N)")
```

## 3.7 Important variable analysis

```{r BIO8}
#Basic plot
plot(bioclim.thai$bio8)

#Nicer plot
bio8.df <- as.data.frame(bioclim.thai$bio8, xy = TRUE)
```

```{r BIO19}
#Basic plot
plot(bioclim.thai$bio19)

#Nicer plot
bio19.df <- as.data.frame(bioclim.thai$bio19, xy = TRUE)
```
