---
title: "SDMs of Leucobryum"
author: "Puwadol Chawengkul"
date: "8/22/2021"
output: pdf_document
editor_options: 
  chunk_output_type: console
---

# 0. Load the libraries

```{r Libraries}
library(maptools)
library(raster) #read shape file
library(tidyverse)
library(rgdal)
library(maps) #map data
library(broom)
library(dismo) #species distribution
library(rJava)
library(randomForest)
library(plyr)

set.seed(1) #set random number for entire script
```

# 1. Main map

## 1.1 Get map data

```{r Get map data}
thai0 <- getData("GADM", country = "THA", level = 0)
thai1 <- getData("GADM", country = "THA", level = 1)
```

## 1.2 ggplot2 map

```{r ggplot2 map}
ggplot() +
  geom_polygon(aes(long, lat, group = group), data = thai0, 
               fill = "#99d8c9", color = "#2ca25f") +
  coord_equal() +
  theme_minimal() +
  theme(panel.background = element_rect(fill = "#E9FFFF")) +
  labs(x = "Longtitude (°E)", y = "Latitude (°N)") 
```

# 2. Species occurrence

## 2.1 Import from GBIF

```{r Import from GBIF}
gbif <- gbif("leucobryum","aduncum")
```

Clean data

```{r Clean GBIF data}
gbif.clean <- gbif %>% 
  #remove Leucobryum aduncum var. scalare
  filter(acceptedScientificName == "Leucobryum aduncum Dozy & Molkenboer, 1854") %>% 
  filter(fullCountry == "Thailand") %>% 
  select(lon, lat) %>% 
  na.omit()
```

## 2.2 Import from .csv

```{r Import from .csv}
csv <- read_csv("Leucobryum-Specimens.csv")
```

Clean data

```{r Clean .csv data}
csv.clean <- csv %>% 
  filter(Corrected_name == "Leucobryum aduncum") %>% 
  select(lon, lat) %>% 
  na.omit()
```

## 2.3 Merge GBIF and .csv

```{r Merge GBIF and .csv}
gbif.csv <- rbind(gbif.clean,csv.clean)
```

## 2.4 Species occurrence plot

```{r Species occurrence plot}
ggplot() +
  geom_polygon(aes(long, lat, group = group), data = thai1, fill = "white", color = "black") +
  geom_point(aes(lon, lat), data = gbif.csv, color = "red", size = 3) +
  coord_equal() +
  theme_minimal() +
  theme(panel.background = element_rect(fill = "#E9FFFF")) +
  labs(x = "Longtitude (°E)", y = "Latitude (°N)") 
```

# 3. Species Distribution Modeling

## 3.1 Get bioclim and elevation data

Get the available bioclim data from the worldclim dataset. See more at [Bioclimatic variables](https://www.worldclim.org/data/bioclim.html)

```{r Get bioclim data}
bioclim <- getData('worldclim', var = 'bio', res = 2.5)
cmip5.45 <- getData('CMIP5', var = 'bio', res = 2.5, rcp = 45, model = 'AC', year = 70)
cmip5.85 <- getData('CMIP5', var = 'bio', res = 2.5, rcp = 85, model = 'AC', year = 70)
```

Get elevation from SRTM 90 m resolution data between -60 and 60 latitude

```{r Get elevation data}
elevation <- getData('alt', country = "THA", mask = FALSE)
```

Crop climate data to Thailand

```{r Crop bioclim data}
bioclim.thai.crop <- crop(bioclim, thai0)
bioclim.thai <- mask(bioclim.thai.crop, thai0)
plot(bioclim.thai[[1]]) #or plot(bioclim.thai$bio1)

cmip5.45.thai.crop <- crop(cmip5.45, thai0)
cmip5.45.thai <- mask(cmip5.45.thai.crop, thai0)
plot(cmip5.45.thai[[1]]) #or plot(cmip5.45.thai$bio1)

cmip5.85.thai.crop <- crop(cmip5.85, thai0)
cmip5.85.thai <- mask(cmip5.85.thai.crop, thai0)
plot(cmip5.85.thai[[1]]) #or plot(cmip5.85.thai$bio1)
```

Crop elevation data to Thailand

```{r Crop elevation data}
elevation.thai.crop <- crop(elevation, thai0)
elevation.thai.0 <- mask(elevation.thai.crop, thai0)
plot(elevation.thai.0)
```

Elevation variable plot

```{r Elevation variable plot}
elevation.thai.0.df <- as.data.frame(elevation.thai.0, xy = TRUE)

#Calculate midpoint value of probability for color setting
midpoint.alt <- (max(elevation.thai.0.df$THA_alt, na.rm = TRUE)
             -min(elevation.thai.0.df$THA_alt, na.rm = TRUE))/2

ggplot() +
  geom_raster(data = elevation.thai.0.df, aes(x,y, fill = THA_alt)) +
  geom_polygon(aes(long, lat, group = group), data = thai1, fill = NA, color = "gray80", size = 0.1) +
  scale_fill_gradient2("Elevation (m)", 
                      high = "red", mid = "orange", midpoint = midpoint.alt, 
                      low = "white", na.value = NA) +
  theme(panel.background = element_rect(fill = "black")) +
  coord_equal() +
  labs(x = "Longtitude (°E)", y = "Latitude (°N)")
```

Make "elevation.thai" be equal column to "bioclim.thai" (for stacking)

```{r Stack preparation}
elevation.thai <- resample(elevation.thai.0, bioclim.thai, method = "bilinear")
plot(elevation.thai[[1]])
```

## 3.2 Build the models

Select only lon and lat of species occurrence

```{r Select lon and lat}
gbif.csv.xy <- select(gbif.csv, lon, lat)
gbif.csv.xy
```

Split into training and testing dataset

```{r Split training and testing}
numrow <- nrow(gbif.csv.xy)
sample <- sample(numrow, 0.3 * numrow)
gbif.csv.xy.train <- gbif.csv.xy[-sample, ]
gbif.csv.xy.test <- gbif.csv.xy[sample, ]
```

Create predictors

```{r Create predictors}
predictors <- stack(bioclim.thai[[c(1:19)]], elevation.thai) #choose bio1-19 and THA_alt
predictors.45 <- stack(cmip5.45.thai[[c(1:19)]], elevation.thai) #choose bio1-19 and THA_alt
predictors.85 <- stack(cmip5.85.thai[[c(1:19)]], elevation.thai) #choose bio1-19 and THA_alt
```

Create random background points

```{r Create random background points}
bg <- randomPoints(predictors, 1000)
numrow.bg <- nrow(bg)
sample.bg <- sample(numrow.bg, 0.3 * numrow.bg)
bg.train <- bg[-sample.bg, ]
bg.test <- bg[sample.bg, ]

bg.45 <- randomPoints(predictors, 1000)
numrow.bg.45 <- nrow(bg.45)
sample.bg.45 <- sample(numrow.bg.45, 0.3 * numrow.bg.45)
bg.45.train <- bg.45[-sample.bg.45, ]
bg.45.test <- bg.45[sample.bg.45, ]

bg.85 <- randomPoints(predictors, 1000)
numrow.bg.85 <- nrow(bg.85)
sample.bg.85 <- sample(numrow.bg.85, 0.3 * numrow.bg.85)
bg.85.train <- bg.85[-sample.bg.85, ]
bg.85.test <- bg.85[sample.bg.85, ]
```

### 3.2.1 Build Bioclim model

```{r Build Bioclim model}
bc.model <- bioclim(x = predictors, p = gbif.csv.xy.train)
bc.model

bc.model.45 <- bioclim(x = predictors.45, p = gbif.csv.xy.train)
bc.model.45

bc.model.85 <- bioclim(x = predictors.85, p = gbif.csv.xy.train)
bc.model.85
```

### 3.2.2 Build MaxEnt model

```{r Build MaxEnt model}
me.model <- maxent(x = predictors, p = gbif.csv.xy.train)
me.model

me.model.45 <- maxent(x = predictors.45, p = gbif.csv.xy.train)
me.model.45

me.model.85 <- maxent(x = predictors.85, p = gbif.csv.xy.train)
me.model.85
```

### 3.2.3 Build GLM model

Create present and absent environmental dataset

```{r Create present and absent environmental dataset}
colnames(bg.train) <- c("lon","lat")
train <- rbind(gbif.csv.xy.train, bg.train)
pb.train <- c(rep(1, nrow(gbif.csv.xy.train)), rep(0, nrow(bg.train)))
envtrain.0 <- raster::extract(predictors, train)
envtrain <- data.frame(cbind(pa=pb.train, envtrain.0))

colnames(bg.45.train) <- c("lon","lat")
train.45 <- rbind(gbif.csv.xy.train, bg.45.train)
pb.train.45 <- c(rep(1, nrow(gbif.csv.xy.train)), rep(0, nrow(bg.45.train)))
envtrain.45.0 <- raster::extract(predictors.45, train.45)
envtrain.45 <- data.frame(cbind(pa=pb.train.45, envtrain.45.0))

colnames(bg.85.train) <- c("lon","lat")
train.85 <- rbind(gbif.csv.xy.train, bg.85.train)
pb.train.85 <- c(rep(1, nrow(gbif.csv.xy.train)), rep(0, nrow(bg.85.train)))
envtrain.85.0 <- raster::extract(predictors.85, train.85)
envtrain.85 <- data.frame(cbind(pa=pb.train.85, envtrain.85.0))
```

```{r Build GLM model}
glm.model <- glm(pa ~ ., family = gaussian(link = "identity"), data=envtrain)
glm.model
#predict(glm.model)

glm.model.45 <- glm(pa ~ ., family = gaussian(link = "identity"), data=envtrain.45)
glm.model.45
#predict(glm.model.45)

glm.model.85 <- glm(pa ~ ., family = gaussian(link = "identity"), data=envtrain.85)
glm.model.85
#predict(glm.model.85)
```

### 3.2.4 Build Random Forest model

This model also need present and absent environmental dataset

```{r Build Random Forest model}
rf.model <- randomForest(pa ~ ., data = envtrain, na.action = na.omit)
rf.model

rf.model.45 <- randomForest(pa ~ ., data = envtrain.45, na.action = na.omit)
rf.model.45

rf.model.85 <- randomForest(pa ~ ., data = envtrain.85, na.action = na.omit)
rf.model.85
```

## 3.3 See the response curves

### 3.3.1 Bioclim model response curves

```{r Bioclim model response curves}
#response(bc.model) #Figure margins too large
#response(bc.model, var = "bio1") #For example
response(bc.model, var = c(1:5))
response(bc.model, var = c(6:10))
response(bc.model, var = c(11:15))
response(bc.model, var = c(16:20))

response(bc.model.45, var = c(1:5))
response(bc.model.45, var = c(6:10))
response(bc.model.45, var = c(11:15))
response(bc.model.45, var = c(16:20))

response(bc.model.85, var = c(1:5))
response(bc.model.85, var = c(6:10))
response(bc.model.85, var = c(11:15))
response(bc.model.85, var = c(16:20))
```

### 3.3.2 MaxEnt model response curves

```{r Variable contribution}
plot(me.model)

plot(me.model.45)

plot(me.model.85)
```

```{r MaxEnt model response curves}
response(me.model, var = c(1:5))
response(me.model, var = c(6:10))
response(me.model, var = c(11:15))
response(me.model, var = c(16:20))

response(me.model.45, var = c(1:5))
response(me.model.45, var = c(6:10))
response(me.model.45, var = c(11:15))
response(me.model.45, var = c(16:20))

response(me.model.85, var = c(1:5))
response(me.model.85, var = c(6:10))
response(me.model.85, var = c(11:15))
response(me.model.85, var = c(16:20))
```

### 3.3.3 GLM model response curves

```{r GLM model response curves}
#response(glm.model, var = c(1:5))
#response(glm.model, var = c(6:10))
#response(glm.model, var = c(11:15))
#response(glm.model, var = c(16:20))
```

### 3.3.4 Random Forest model response curves

```{r Random Forest model response curves}
#response(rf.model, var = c(1:5))
#response(rf.model, var = c(6:10))
#response(rf.model, var = c(11:15))
#response(rf.model, var = c(16:20))
```

## 3.4 Plot the predicted data onto the map

Distribution model predictions

```{r Distribution model predictions}
predict.presence.bc <- dismo::predict(object = bc.model, x = predictors)
predict.presence.me <- dismo::predict(object = me.model, x = predictors)
ext <- extent(90, 110, 5, 22)
predict.presence.glm <- predict(predictors, glm.model, ext=ext)
predict.presence.rf <- predict(predictors, rf.model, ext=ext)

predict.presence.bc.45 <- dismo::predict(object = bc.model.45, x = predictors.45)
predict.presence.me.45 <- dismo::predict(object = me.model.45, x = predictors.45)
ext <- extent(90, 110, 5, 22)
predict.presence.glm.45 <- predict(predictors.45, glm.model.45, ext=ext)
predict.presence.rf.45 <- predict(predictors.45, rf.model.45, ext=ext)

predict.presence.bc.85 <- dismo::predict(object = bc.model.85, x = predictors.85)
predict.presence.me.85 <- dismo::predict(object = me.model.85, x = predictors.85)
ext <- extent(90, 110, 5, 22)
predict.presence.glm.85 <- predict(predictors.85, glm.model.85, ext=ext)
predict.presence.rf.85 <- predict(predictors.85, rf.model.85, ext=ext)
```

Basic plot

```{r Basic plot}
#For example only
plot(predict.presence.bc)
points(lat ~ lon, data = gbif.csv.xy, col = "red") #Have problem if zoom

plot(predict.presence.bc.45)
points(lat ~ lon, data = gbif.csv.xy, col = "red") #Have problem if zoom

plot(predict.presence.bc.85)
points(lat ~ lon, data = gbif.csv.xy, col = "red") #Have problem if zoom
```

Plot in ggplot2

### 3.4.1 Turn raster into df

```{r Turn raster into df}
predict.presence.bc.df <- as.data.frame(predict.presence.bc, xy = TRUE) %>% 
  mutate(layer2 = ifelse(layer=="NaN",NA,layer)) #Clean layer for transparent background
predict.presence.me.df <- as.data.frame(predict.presence.me, xy = TRUE) %>% 
  mutate(layer2 = ifelse(layer=="NaN",NA,layer)) #Clean layer for transparent background
predict.presence.glm.df <- as.data.frame(predict.presence.glm, xy = TRUE) %>% 
  mutate(layer2 = ifelse(layer=="NaN",NA,layer)) #Clean layer for transparent background
predict.presence.rf.df <- as.data.frame(predict.presence.rf, xy = TRUE) %>% 
  mutate(layer2 = ifelse(layer=="NaN",NA,layer)) #Clean layer for transparent background

predict.presence.bc.45.df <- as.data.frame(predict.presence.bc.45, xy = TRUE) %>% 
  mutate(layer2 = ifelse(layer=="NaN",NA,layer)) #Clean layer for transparent background
predict.presence.me.45.df <- as.data.frame(predict.presence.me.45, xy = TRUE) %>% 
  mutate(layer2 = ifelse(layer=="NaN",NA,layer)) #Clean layer for transparent background
predict.presence.glm.45.df <- as.data.frame(predict.presence.glm.45, xy = TRUE) %>% 
  mutate(layer2 = ifelse(layer=="NaN",NA,layer)) #Clean layer for transparent background
predict.presence.rf.45.df <- as.data.frame(predict.presence.rf.45, xy = TRUE) %>% 
  mutate(layer2 = ifelse(layer=="NaN",NA,layer)) #Clean layer for transparent background

predict.presence.bc.85.df <- as.data.frame(predict.presence.bc.85, xy = TRUE) %>% 
  mutate(layer2 = ifelse(layer=="NaN",NA,layer)) #Clean layer for transparent background
predict.presence.me.85.df <- as.data.frame(predict.presence.me.85, xy = TRUE) %>% 
  mutate(layer2 = ifelse(layer=="NaN",NA,layer)) #Clean layer for transparent background
predict.presence.glm.85.df <- as.data.frame(predict.presence.glm.85, xy = TRUE) %>% 
  mutate(layer2 = ifelse(layer=="NaN",NA,layer)) #Clean layer for transparent background
predict.presence.rf.85.df <- as.data.frame(predict.presence.rf.85, xy = TRUE) %>% 
  mutate(layer2 = ifelse(layer=="NaN",NA,layer)) #Clean layer for transparent background
```

### 3.4.2 Bioclim model plot

```{r Bioclim model plot}
#Calculate midpoint value of probability for color setting
midpoint.bc <- (max(predict.presence.bc.df$layer2, na.rm = TRUE)
             -min(predict.presence.bc.df$layer2, na.rm = TRUE))/2

ggplot() +
  geom_raster(data = predict.presence.bc.df, aes(x,y, fill = layer2)) +
  geom_polygon(aes(long, lat, group = group), data = thai1, fill = NA, color = "gray80", size = 0.1) +
  geom_point(data = gbif.csv.xy, aes(lon, lat), color = "dark green", shape = 1) +
  scale_fill_gradient2("probability", 
                      high = "red", mid = "orange", midpoint = midpoint.bc, 
                      low = "white", na.value = NA) +
  theme(panel.background = element_rect(fill = "black")) +
  coord_equal() +
  labs(x = "Longtitude (°E)", y = "Latitude (°N)")

midpoint.bc.45 <- (max(predict.presence.bc.45.df$layer2, na.rm = TRUE)
             -min(predict.presence.bc.45.df$layer2, na.rm = TRUE))/2

ggplot() +
  geom_raster(data = predict.presence.bc.45.df, aes(x,y, fill = layer2)) +
  geom_polygon(aes(long, lat, group = group), data = thai1, fill = NA, color = "gray80", size = 0.1) +
  geom_point(data = gbif.csv.xy, aes(lon, lat), color = "dark green", shape = 1) +
  scale_fill_gradient2("probability", 
                      high = "red", mid = "orange", midpoint = midpoint.bc.45, 
                      low = "white", na.value = NA) +
  theme(panel.background = element_rect(fill = "black")) +
  coord_equal() +
  labs(x = "Longtitude (°E)", y = "Latitude (°N)")

midpoint.bc.85 <- (max(predict.presence.bc.85.df$layer2, na.rm = TRUE)
             -min(predict.presence.bc.85.df$layer2, na.rm = TRUE))/2

ggplot() +
  geom_raster(data = predict.presence.bc.85.df, aes(x,y, fill = layer2)) +
  geom_polygon(aes(long, lat, group = group), data = thai1, fill = NA, color = "gray80", size = 0.1) +
  geom_point(data = gbif.csv.xy, aes(lon, lat), color = "dark green", shape = 1) +
  scale_fill_gradient2("probability", 
                      high = "red", mid = "orange", midpoint = midpoint.bc.85, 
                      low = "white", na.value = NA) +
  theme(panel.background = element_rect(fill = "black")) +
  coord_equal() +
  labs(x = "Longtitude (°E)", y = "Latitude (°N)")
```

### 3.4.3 MaxEnt model plot

```{r MaxEnt model plot}
#Calculate midpoint value of probability for color setting
midpoint.me <- (max(predict.presence.me.df$layer2, na.rm = TRUE)
             -min(predict.presence.me.df$layer2, na.rm = TRUE))/2

ggplot() +
  geom_raster(data = predict.presence.me.df, aes(x,y, fill = layer2)) +
  geom_polygon(aes(long, lat, group = group), data = thai1, fill = NA, color = "gray80", size = 0.1) +
  geom_point(data = gbif.csv.xy, aes(lon, lat), color = "dark green", shape = 1) +
  scale_fill_gradient2("probability", 
                      high = "red", mid = "orange", midpoint = midpoint.me, 
                      low = "white", na.value = NA) +
  theme(panel.background = element_rect(fill = "black")) +
  coord_equal() +
  labs(x = "Longtitude (°E)", y = "Latitude (°N)")

midpoint.me.45 <- (max(predict.presence.me.45.df$layer2, na.rm = TRUE)
             -min(predict.presence.me.45.df$layer2, na.rm = TRUE))/2

ggplot() +
  geom_raster(data = predict.presence.me.45.df, aes(x,y, fill = layer2)) +
  geom_polygon(aes(long, lat, group = group), data = thai1, fill = NA, color = "gray80", size = 0.1) +
  geom_point(data = gbif.csv.xy, aes(lon, lat), color = "dark green", shape = 1) +
  scale_fill_gradient2("probability", 
                      high = "red", mid = "orange", midpoint = midpoint.me.45, 
                      low = "white", na.value = NA) +
  theme(panel.background = element_rect(fill = "black")) +
  coord_equal() +
  labs(x = "Longtitude (°E)", y = "Latitude (°N)")

midpoint.me.85 <- (max(predict.presence.me.85.df$layer2, na.rm = TRUE)
             -min(predict.presence.me.85.df$layer2, na.rm = TRUE))/2

ggplot() +
  geom_raster(data = predict.presence.me.85.df, aes(x,y, fill = layer2)) +
  geom_polygon(aes(long, lat, group = group), data = thai1, fill = NA, color = "gray80", size = 0.1) +
  geom_point(data = gbif.csv.xy, aes(lon, lat), color = "dark green", shape = 1) +
  scale_fill_gradient2("probability", 
                      high = "red", mid = "orange", midpoint = midpoint.me.85, 
                      low = "white", na.value = NA) +
  theme(panel.background = element_rect(fill = "black")) +
  coord_equal() +
  labs(x = "Longtitude (°E)", y = "Latitude (°N)")
```

### 3.4.4 GLM model plot

```{r GLM model plot}
#Calculate midpoint value of probability for color setting
midpoint.glm <- (max(predict.presence.glm.df$layer2, na.rm = TRUE)
             -min(predict.presence.glm.df$layer2, na.rm = TRUE))/2

ggplot() +
  geom_raster(data = predict.presence.glm.df, aes(x,y, fill = layer2)) +
  geom_polygon(aes(long, lat, group = group), data = thai1, fill = NA, color = "gray80", size = 0.1) +
  geom_point(data = gbif.csv.xy, aes(lon, lat), color = "dark green", shape = 1) +
  scale_fill_gradient2("probability", 
                      high = "red", mid = "orange", midpoint = midpoint.glm, 
                      low = "white", na.value = NA) +
  theme(panel.background = element_rect(fill = "black")) +
  coord_equal() +
  labs(x = "Longtitude (°E)", y = "Latitude (°N)")
#hist(predict.presence.glm.df$layer2)

midpoint.glm.45 <- (max(predict.presence.glm.45.df$layer2, na.rm = TRUE)
             -min(predict.presence.glm.45.df$layer2, na.rm = TRUE))/2

ggplot() +
  geom_raster(data = predict.presence.glm.45.df, aes(x,y, fill = layer2)) +
  geom_polygon(aes(long, lat, group = group), data = thai1, fill = NA, color = "gray80", size = 0.1) +
  geom_point(data = gbif.csv.xy, aes(lon, lat), color = "dark green", shape = 1) +
  scale_fill_gradient2("probability", 
                      high = "red", mid = "orange", midpoint = midpoint.glm.45, 
                      low = "white", na.value = NA) +
  theme(panel.background = element_rect(fill = "black")) +
  coord_equal() +
  labs(x = "Longtitude (°E)", y = "Latitude (°N)")
#hist(predict.presence.glm.45.df$layer2)

midpoint.glm.85 <- (max(predict.presence.glm.85.df$layer2, na.rm = TRUE)
             -min(predict.presence.glm.85.df$layer2, na.rm = TRUE))/2

ggplot() +
  geom_raster(data = predict.presence.glm.85.df, aes(x,y, fill = layer2)) +
  geom_polygon(aes(long, lat, group = group), data = thai1, fill = NA, color = "gray80", size = 0.1) +
  geom_point(data = gbif.csv.xy, aes(lon, lat), color = "dark green", shape = 1) +
  scale_fill_gradient2("probability", 
                      high = "red", mid = "orange", midpoint = midpoint.glm.85, 
                      low = "white", na.value = NA) +
  theme(panel.background = element_rect(fill = "black")) +
  coord_equal() +
  labs(x = "Longtitude (°E)", y = "Latitude (°N)")
#hist(predict.presence.glm.85.df$layer2)
```

### 3.4.5 Random Forest model plot

```{r Random Forest model plot}
#Calculate midpoint value of probability for color setting
midpoint.rf <- (max(predict.presence.rf.df$layer2, na.rm = TRUE)
             -min(predict.presence.rf.df$layer2, na.rm = TRUE))/2

ggplot() +
  geom_raster(data = predict.presence.rf.df, aes(x,y, fill = layer2)) +
  geom_polygon(aes(long, lat, group = group), data = thai1, fill = NA, color = "gray80", size = 0.1) +
  geom_point(data = gbif.csv.xy, aes(lon, lat), color = "dark green", shape = 1) +
  scale_fill_gradient2("probability", 
                      high = "red", mid = "orange", midpoint = midpoint.rf, 
                      low = "white", na.value = NA) +
  theme(panel.background = element_rect(fill = "black")) +
  coord_equal() +
  labs(x = "Longtitude (°E)", y = "Latitude (°N)")

midpoint.rf.45 <- (max(predict.presence.rf.45.df$layer2, na.rm = TRUE)
             -min(predict.presence.rf.45.df$layer2, na.rm = TRUE))/2

ggplot() +
  geom_raster(data = predict.presence.rf.45.df, aes(x,y, fill = layer2)) +
  geom_polygon(aes(long, lat, group = group), data = thai1, fill = NA, color = "gray80", size = 0.1) +
  geom_point(data = gbif.csv.xy, aes(lon, lat), color = "dark green", shape = 1) +
  scale_fill_gradient2("probability", 
                      high = "red", mid = "orange", midpoint = midpoint.rf.45, 
                      low = "white", na.value = NA) +
  theme(panel.background = element_rect(fill = "black")) +
  coord_equal() +
  labs(x = "Longtitude (°E)", y = "Latitude (°N)")

midpoint.rf.85 <- (max(predict.presence.rf.85.df$layer2, na.rm = TRUE)
             -min(predict.presence.rf.85.df$layer2, na.rm = TRUE))/2

ggplot() +
  geom_raster(data = predict.presence.rf.85.df, aes(x,y, fill = layer2)) +
  geom_polygon(aes(long, lat, group = group), data = thai1, fill = NA, color = "gray80", size = 0.1) +
  geom_point(data = gbif.csv.xy, aes(lon, lat), color = "dark green", shape = 1) +
  scale_fill_gradient2("probability", 
                      high = "red", mid = "orange", midpoint = midpoint.rf.85, 
                      low = "white", na.value = NA) +
  theme(panel.background = element_rect(fill = "black")) +
  coord_equal() +
  labs(x = "Longtitude (°E)", y = "Latitude (°N)")
```

## 3.5 Evaluate the model

AUC = Area Under Curve is the area under the curve of True Positive Rate (TPR) vs. False Positive Rate (FPR) If AUC is high, it means more likely to get the correct prediction (true positives)

Check Spatial Sorting Bias (SSB)

```{r Check Spatial Sorting Bias (SSB)}
ssb <- ssb(gbif.csv.xy.test, bg.test, gbif.csv.xy.train)
ssb[,1] / ssb[,2]
#If there is no SSB this value should be 1, close to 0 indicating that SSB is very strong.

ssb.45 <- ssb(gbif.csv.xy.test, bg.45.test, gbif.csv.xy.train)
ssb.45[,1] / ssb.45[,2]
#If there is no SSB this value should be 1, close to 0 indicating that SSB is very strong.

ssb.85 <- ssb(gbif.csv.xy.test, bg.85.test, gbif.csv.xy.train)
ssb.85[,1] / ssb.85[,2]
#If there is no SSB this value should be 1, close to 0 indicating that SSB is very strong.
```

Subsample to remove SSB

```{r Remove SSB}
i <- pwdSample(gbif.csv.xy.test, bg.test, gbif.csv.xy.train, n=1, tr=0.1)
gbif.csv.xy.test.pwd <- gbif.csv.xy.test[!is.na(i[,1]), ]
bg.test.pwd <- bg.test[na.omit(as.vector(i)), ]
sb2 <- ssb(gbif.csv.xy.test.pwd, bg.test.pwd, gbif.csv.xy.train)
sb2[1]/sb2[2]

i.45 <- pwdSample(gbif.csv.xy.test, bg.45.test, gbif.csv.xy.train, n=1, tr=0.1)
gbif.csv.xy.test.pwd.45 <- gbif.csv.xy.test[!is.na(i.45[,1]), ]
bg.test.pwd.45 <- bg.test[na.omit(as.vector(i.45)), ]
sb2.45 <- ssb(gbif.csv.xy.test.pwd.45, bg.test.pwd.45, gbif.csv.xy.train)
sb2.45[1]/sb2.45[2]

i.85 <- pwdSample(gbif.csv.xy.test, bg.85.test, gbif.csv.xy.train, n=1, tr=0.1)
gbif.csv.xy.test.pwd.85 <- gbif.csv.xy.test[!is.na(i.85[,1]), ]
bg.test.pwd.85 <- bg.test[na.omit(as.vector(i.85)), ]
sb2.85 <- ssb(gbif.csv.xy.test.pwd.85, bg.test.pwd.85, gbif.csv.xy.train)
sb2.85[1]/sb2.85[2]
```

### 3.5.1 Before remove SSB (don't use)

```{r Evaluate Bioclim model with SSB}
e.bc.0 <- evaluate(bc.model, p=gbif.csv.xy.test, a=bg.test, x= predictors)
e.bc.0
plot(e.bc.0, "ROC") #Visualize AUC with ROC curve
```

```{r Evaluate MaxEnt model with SSB}
e.me.0 <- evaluate(me.model, p=gbif.csv.xy.test, a=bg.test, x= predictors)
e.me.0
plot(e.me.0, "ROC") #Visualize AUC with ROC curve
```

```{r Evaluate GLM model with SSB}
e.glm.0 <- evaluate(glm.model, p=gbif.csv.xy.test, a=bg.test, x= predictors)
e.glm.0
plot(e.glm.0, "ROC") #Visualize AUC with ROC curve
```

```{r Evaluate Random Forest model with SSB}
e.rf.0 <- evaluate(glm.model, p=gbif.csv.xy.test, a=bg.test, x= predictors)
e.rf.0
plot(e.rf.0, "ROC") #Visualize AUC with ROC curve
```

### 3.5.2 After remove SSB

```{r Evaluate Bioclim model without SSB}
e.bc <- evaluate(bc.model, p=gbif.csv.xy.test.pwd, a=bg.test.pwd, x= predictors)
e.bc
plot(e.bc, "ROC") #Visualize AUC with ROC curve

e.bc.45 <- evaluate(bc.model.45, p=gbif.csv.xy.test.pwd.45, a=bg.test.pwd.45, x= predictors.45)
e.bc.45
plot(e.bc.45, "ROC") #Visualize AUC with ROC curve

e.bc.85 <- evaluate(bc.model.85, p=gbif.csv.xy.test.pwd.85, a=bg.test.pwd.85, x= predictors.85)
e.bc.85
plot(e.bc.85, "ROC") #Visualize AUC with ROC curve
```

```{r Evaluate MaxEnt model without SSB}
e.me <- evaluate(me.model, p=gbif.csv.xy.test.pwd, a=bg.test.pwd, x= predictors)
e.me
plot(e.me, "ROC") #Visualize AUC with ROC curve

e.me.45 <- evaluate(me.model.45, p=gbif.csv.xy.test.pwd.45, a=bg.test.pwd.45, x= predictors.45)
e.me.45
plot(e.me.45, "ROC") #Visualize AUC with ROC curve

e.me.85 <- evaluate(me.model.85, p=gbif.csv.xy.test.pwd.85, a=bg.test.pwd.85, x= predictors.85)
e.me.85
plot(e.me.85, "ROC") #Visualize AUC with ROC curve
```

```{r Evaluate GLM model without SSB}
e.glm <- evaluate(glm.model, p=gbif.csv.xy.test.pwd, a=bg.test.pwd, x= predictors)
e.glm
plot(e.glm, "ROC") #Visualize AUC with ROC curve

e.glm.45 <- evaluate(glm.model.45, p=gbif.csv.xy.test.pwd.45, a=bg.test.pwd.45, x= predictors.45)
e.glm.45
plot(e.glm.45, "ROC") #Visualize AUC with ROC curve

e.glm.85 <- evaluate(glm.model.85, p=gbif.csv.xy.test.pwd.85, a=bg.test.pwd.85, x= predictors.85)
e.glm.85
plot(e.glm.85, "ROC") #Visualize AUC with ROC curve
```

```{r Evaluate Random Forest model without SSB}
e.rf <- evaluate(rf.model, p=gbif.csv.xy.test.pwd, a=bg.test.pwd, x= predictors)
e.rf
plot(e.rf, "ROC") #Visualize AUC with ROC curve

e.rf.45 <- evaluate(rf.model.45, p=gbif.csv.xy.test.pwd.45, a=bg.test.pwd.45, x= predictors.45)
e.rf.45
plot(e.rf.45, "ROC") #Visualize AUC with ROC curve

e.rf.85 <- evaluate(rf.model.85, p=gbif.csv.xy.test.pwd.85, a=bg.test.pwd.85, x= predictors.85)
e.rf.85
plot(e.rf.85, "ROC") #Visualize AUC with ROC curve
```

## 3.6 Combined model predictions

```{r Make a raster stack}
models <- stack(predict.presence.bc, predict.presence.me, 
                predict.presence.glm, predict.presence.rf)
names(models) <- c("Bioclim", "Maxent", "GLM", "RF")
plot(models)

models.45 <- stack(predict.presence.bc.45, predict.presence.me.45, 
                predict.presence.glm.45, predict.presence.rf.45)
names(models.45) <- c("Bioclim.45", "Maxent.45", "GLM.45", "RF.45")
plot(models.45)

models.85 <- stack(predict.presence.bc.85, predict.presence.me.85, 
                predict.presence.glm.85, predict.presence.rf.85)
names(models.85) <- c("Bioclim.85", "Maxent.85", "GLM.85", "RF.85")
plot(models.85)
```

```{r Simple average}
mean.models <- mean(models)
mean.models.45 <- mean(models.45)
mean.models.85 <- mean(models.85)

#Basic plot
plot(mean.models, main = "Average score")
plot(mean.models.45, main = "Average score.45")
plot(mean.models.85, main = "Average score.85")
```

```{r Weighted mean of all models}
auc <- sapply(list(e.bc, e.me, e.glm, e.rf), function(x) x@auc)
weight <- (auc-0.5)^2
weight.model <- weighted.mean(models[[c("Bioclim", "Maxent", "GLM", "RF")]], weight)

auc.45 <- sapply(list(e.bc.45, e.me.45, e.glm.45, e.rf.45), function(x) x@auc)
weight.45 <- (auc.45-0.5)^2
weight.model.45 <- weighted.mean(models.45[[c("Bioclim.45", "Maxent.45", "GLM.45", "RF.45")]], weight.45)

auc.85 <- sapply(list(e.bc.85, e.me.85, e.glm.85, e.rf.85), function(x) x@auc)
weight.85 <- (auc.85-0.5)^2
weight.model.85 <- weighted.mean(models.85[[c("Bioclim.85", "Maxent.85", "GLM.85", "RF.85")]], weight.85)

#Basic plot
plot(weight.model, main = "Weighted mean of all models")
plot(weight.model.45, main = "Weighted mean of all models.45")
plot(weight.model.85, main = "Weighted mean of all models.85")

#Turn raster into df
predict.presence.w.df <- as.data.frame(weight.model, xy = TRUE) %>% 
  mutate(layer2 = ifelse(layer=="NaN",NA,layer)) #Clean layer for transparent background

predict.presence.w.45.df <- as.data.frame(weight.model.45, xy = TRUE) %>% 
  mutate(layer2 = ifelse(layer=="NaN",NA,layer)) #Clean layer for transparent background

predict.presence.w.85.df <- as.data.frame(weight.model.85, xy = TRUE) %>% 
  mutate(layer2 = ifelse(layer=="NaN",NA,layer)) #Clean layer for transparent background

#Calculate midpoint value of probability for color setting
midpoint.w <- (max(predict.presence.w.df$layer2, na.rm = TRUE)
             -min(predict.presence.w.df$layer2, na.rm = TRUE))/2

ggplot() +
  geom_raster(data = predict.presence.w.df, aes(x,y, fill = layer2)) +
  geom_polygon(aes(long, lat, group = group), data = thai1, fill = NA, color = "gray80", size = 0.1) +
  geom_point(data = gbif.csv.xy, aes(lon, lat), color = "red", shape = 1) +
  scale_fill_gradient2("probability", 
                      high = "dark green", mid = "green", midpoint = 0.3, 
                      low = "white", na.value = NA, breaks = c(0,0.25,0.5,0.75), limits = c(0,0.75)) +
  theme(panel.background = element_rect(fill = "black")) +
  coord_equal() +
  labs(x = "Longtitude (°E)", y = "Latitude (°N)")

midpoint.w.45 <- (max(predict.presence.w.45.df$layer2, na.rm = TRUE)
             -min(predict.presence.w.45.df$layer2, na.rm = TRUE))/2

ggplot() +
  geom_raster(data = predict.presence.w.45.df, aes(x,y, fill = layer2)) +
  geom_polygon(aes(long, lat, group = group), data = thai1, fill = NA, color = "gray80", size = 0.1) +
  geom_point(data = gbif.csv.xy, aes(lon, lat), color = "red", shape = 1) +
  scale_fill_gradient2("probability", 
                      high = "dark green", mid = "green", midpoint = 0.3, 
                      low = "white", na.value = NA, breaks = c(0,0.25,0.5,0.75), limits = c(0,0.75)) +
  theme(panel.background = element_rect(fill = "black")) +
  coord_equal() +
  labs(x = "Longtitude (°E)", y = "Latitude (°N)")

midpoint.w.85 <- (max(predict.presence.w.85.df$layer2, na.rm = TRUE)
             -min(predict.presence.w.85.df$layer2, na.rm = TRUE))/2

ggplot() +
  geom_raster(data = predict.presence.w.85.df, aes(x,y, fill = layer2)) +
  geom_polygon(aes(long, lat, group = group), data = thai1, fill = NA, color = "gray80", size = 0.1) +
  geom_point(data = gbif.csv.xy, aes(lon, lat), color = "red", shape = 1) +
  scale_fill_gradient2("probability", 
                      high = "dark green", mid = "green", midpoint = 0.3, 
                      low = "white", na.value = NA, breaks = c(0,0.25,0.5,0.75), limits = c(0,0.75)) +
  theme(panel.background = element_rect(fill = "black")) +
  coord_equal() +
  labs(x = "Longtitude (°E)", y = "Latitude (°N)")
```

## 3.7 Calculate changing of probability

```{r Histogram of probability changing}
change.45.0 <- left_join(predict.presence.w.df, predict.presence.w.45.df, by = c("x","y"))
change.45 <- mutate(change.45.0, change = layer2.y - layer2.x)

#Basic plot
hist(change.45$change, col = "blue", main = "Histogram of change 45 vs 85")

change.85.0 <- left_join(predict.presence.w.df, predict.presence.w.85.df, by = c("x","y"))
change.85 <- mutate(change.85.0, change = layer2.y - layer2.x)
#hist(change.85$change, col = "red")
hist(change.85$change, add = T, col = "red")

#Nicer plot
change.45.name <- mutate(change.45, Scene = "Moderate")
change.85.name <- mutate(change.85, Scene = "Severe")
change.45.85 <- bind_rows(change.45.name, change.85.name)

mu.change.45.85 <- ddply(change.45.85, "Scene", summarise, grp.mean=mean(change, na.rm = TRUE))
head(mu.change.45.85)

ggplot(change.45.85, aes(x = change, fill = Scene, color = Scene)) +
  geom_histogram(position = "identity", alpha = 0.5, binwidth = 0.01) +
  geom_vline(data = mu.change.45.85, aes(xintercept = grp.mean, color = Scene), linetype="dashed") +
  geom_vline(xintercept = 0) +
  theme(legend.position="top") +
  scale_color_manual(values = c("dark green","red3")) +
  scale_fill_manual(values = c("dark green","red3")) +
  labs(x = "Change of prob.", y = "Pixels")
```

```{r Probability changing plot}
ggplot() +
  geom_raster(data = change.45, aes(x,y, fill = change)) +
  geom_polygon(aes(long, lat, group = group), data = thai1, fill = NA, color = "gray80", size = 0.1) +
#  geom_point(data = gbif.csv.xy, aes(lon, lat), color = "dark green", shape = 1) +
  scale_fill_gradient2("Prob. change", 
                      high = "blue", mid = "white", midpoint = 0.0, 
                      low = "red", na.value = NA, 
                      breaks=c(-0.3,-0.2,-0.1,0,0.1,0.2), limits=c(-0.3,0.2)) +
  theme(panel.background = element_rect(fill = "black")) +
  coord_equal() +
  labs(x = "Longtitude (°E)", y = "Latitude (°N)")

ggplot() +
  geom_raster(data = change.85, aes(x,y, fill = change)) +
  geom_polygon(aes(long, lat, group = group), data = thai1, fill = NA, color = "gray80", size = 0.1) +
#  geom_point(data = gbif.csv.xy, aes(lon, lat), color = "dark green", shape = 1) +
  scale_fill_gradient2("Prob. change", 
                      high = "blue", mid = "white", midpoint = 0.0, 
                      low = "red", na.value = NA, 
                      breaks=c(-0.3,-0.2,-0.1,0,0.1,0.2), limits=c(-0.3,0.2)) +
  theme(panel.background = element_rect(fill = "black")) +
  coord_equal() +
  labs(x = "Longtitude (°E)", y = "Latitude (°N)")
```

## 3.7 Important variable analysis

```{r BIO8}
#Basic plot
plot(bioclim.thai$bio8)

plot(cmip5.45.thai$ac45bi708)
plot(cmip5.45.thai$ac45bi708-bioclim.thai$bio8)

plot(cmip5.85.thai$ac85bi708-bioclim.thai$bio8)
plot(cmip5.85.thai$ac85bi708-bioclim.thai$bio8)

#Nicer plot
bio8.df <- as.data.frame(bioclim.thai$bio8, xy = TRUE)
bio8.45.df <- as.data.frame(cmip5.45.thai$ac45bi708, xy = TRUE)
bio8.85.df <- as.data.frame(cmip5.85.thai$ac85bi708, xy = TRUE)

change.bio8.45.0 <- left_join(bio8.df, bio8.45.df, by = c("x","y"))
change.bio8.45 <- mutate(change.bio8.45.0, change = ac45bi708 - bio8)

change.bio8.85.0 <- left_join(bio8.df, bio8.85.df, by = c("x","y"))
change.bio8.85 <- mutate(change.bio8.85.0, change = ac85bi708 - bio8)

#Change of BIO8 (RCP 4.5)
ggplot() +
  geom_raster(data = change.bio8.45, aes(x,y, fill = change/10)) + 
  #Temperature must divide by 10
  geom_polygon(aes(long, lat, group = group), data = thai1, fill = NA, color = "gray80", size = 0.1) +
  scale_fill_gradient2("Change (°C)", 
                      high = "red", mid = "orange", midpoint = 2, 
                      low = "white", na.value = NA,
                      breaks=c(0:5), limits=c(0,5)) +
  theme(panel.background = element_rect(fill = "black")) +
  coord_equal() +
  labs(x = "Longtitude (°E)", y = "Latitude (°N)")

#Change of BIO8 (RCP 8.5)
ggplot() +
  geom_raster(data = change.bio8.85, aes(x,y, fill = change/10)) + 
  #Temperature must divide by 10
  geom_polygon(aes(long, lat, group = group), data = thai1, fill = NA, color = "gray80", size = 0.1) +
  scale_fill_gradient2("Change (°C)", 
                      high = "red", mid = "orange", midpoint = 2, 
                      low = "white", na.value = NA, 
                      breaks=c(0:5), limits=c(0,5)) +
  theme(panel.background = element_rect(fill = "black")) +
  coord_equal() +
  labs(x = "Longtitude (°E)", y = "Latitude (°N)")

#Histogram
change.bio8.45.name <- mutate(change.bio8.45, Scene = "Moderate")
change.bio8.85.name <- mutate(change.bio8.85, Scene = "Severe")
change.bio8.45.85.0 <- bind_rows(change.bio8.45.name, change.bio8.85.name)
change.bio8.45.85 <- mutate(change.bio8.45.85.0, change.new = change/10)

mu.change.bio8.45.85 <- ddply(change.bio8.45.85, "Scene", summarise, grp.mean=mean(change.new, na.rm = TRUE))
head(mu.change.bio8.45.85)

ggplot(change.bio8.45.85, aes(x = change.new, fill = Scene, color = Scene)) +
  geom_histogram(position = "identity", alpha = 0.5, binwidth = 0.1) +
  geom_vline(data = mu.change.bio8.45.85, aes(xintercept = grp.mean, color = Scene), linetype="dashed") +
  theme(legend.position="top") +
  scale_color_manual(values = c("dark green","red3")) +
  scale_fill_manual(values = c("dark green","red3")) +
  labs(x = "Increased mean temperature of wettest quarter (°C)", y = "Pixels")
```

```{r BIO19}
#Basic plot
plot(bioclim.thai$bio19)

plot(cmip5.45.thai$ac45bi7019)
plot(cmip5.45.thai$ac45bi7019-bioclim.thai$bio19)

plot(cmip5.85.thai$ac85bi7019-bioclim.thai$bio19)
plot(cmip5.85.thai$ac85bi7019-bioclim.thai$bio19)

#Nicer plot
bio19.df <- as.data.frame(bioclim.thai$bio19, xy = TRUE)
bio19.45.df <- as.data.frame(cmip5.45.thai$ac45bi708, xy = TRUE)
bio19.85.df <- as.data.frame(cmip5.85.thai$ac85bi708, xy = TRUE)

change.bio19.45.0 <- left_join(bio19.df, bio19.45.df, by = c("x","y"))
change.bio19.45 <- mutate(change.bio19.45.0, change = ac45bi708 - bio19)

change.bio19.85.0 <- left_join(bio19.df, bio19.85.df, by = c("x","y"))
change.bio19.85 <- mutate(change.bio19.85.0, change = ac85bi708 - bio19)

#Change of BIO19 (RCP 4.5)
ggplot() +
  geom_raster(data = change.bio19.45, aes(x,y, fill = change)) +
  geom_polygon(aes(long, lat, group = group), data = thai1, fill = NA, color = "gray80", size = 0.1) +
  scale_fill_gradient2("Change (mm)", 
                      high = "dark blue", mid = "white", midpoint = 0, 
                      low = "darkorange2", na.value = NA,
                      breaks=c(-900,-600,-300,0,300), limits=c(-900,400)) +
  theme(panel.background = element_rect(fill = "black")) +
  coord_equal() +
  labs(x = "Longtitude (°E)", y = "Latitude (°N)")

#Change of BIO19 (RCP 8.5)
ggplot() +
  geom_raster(data = change.bio19.85, aes(x,y, fill = change)) +
  geom_polygon(aes(long, lat, group = group), data = thai1, fill = NA, color = "gray80", size = 0.1) +
  scale_fill_gradient2("Change (mm)", 
                      high = "dark blue", mid = "white", midpoint = 0, 
                      low = "darkorange2", na.value = NA,
                      breaks=c(-900,-600,-300,0,300), limits=c(-900,400)) +
  theme(panel.background = element_rect(fill = "black")) +
  coord_equal() +
  labs(x = "Longtitude (°E)", y = "Latitude (°N)")

#Histogram
change.bio19.45.name <- mutate(change.bio19.45, Scene = "Moderate")
change.bio19.85.name <- mutate(change.bio19.85, Scene = "Severe")
change.bio19.45.85 <- bind_rows(change.bio19.45.name, change.bio19.85.name)

mu.change.bio19.45.85 <- ddply(change.bio19.45.85, "Scene", summarise, grp.mean=mean(change, na.rm = TRUE))
head(mu.change.bio19.45.85)

ggplot(change.bio19.45.85, aes(x = change, fill = Scene, color = Scene)) +
  geom_histogram(position = "identity", alpha = 0.5, binwidth = 5) +
  geom_vline(data = mu.change.bio19.45.85, aes(xintercept = grp.mean, color = Scene), linetype="dashed") +
  theme(legend.position="top") +
  scale_color_manual(values = c("dark green","red3")) +
  scale_fill_manual(values = c("dark green","red3")) +
  xlim(100, NA) +
  labs(x = "Increased precipitation of coldest quarter (mm)", y = "Pixels")
```
